# 52주 신고가 돌파 종목 ML 예측 모델 개발 보고서

## 1. 프로젝트 개요

### 1.1 목적
52주 신고가를 돌파한 종목에 대해 머신러닝 모델을 활용하여:
1. **예상 최고 수익률**: 돌파 후 20거래일 내 도달할 최고 수익률 예측
2. **성공 확률**: 10% 이상 상승할 확률 예측

### 1.2 배경
- 52주 신고가 돌파는 기술적 분석에서 강력한 매수 신호로 알려져 있음
- 그러나 모든 돌파가 성공하지는 않으며, 돌파의 "품질"에 따라 결과가 달라짐
- 과거 데이터를 학습하여 돌파 시점의 특성으로 향후 수익률을 예측

### 1.3 시스템 구성
```
[데이터 수집] → [피처 엔지니어링] → [모델 학습] → [실시간 예측]
    ↓                 ↓                 ↓              ↓
 3년간 돌파       14개 기술적        LightGBM      웹사이트
  이벤트 수집       지표 계산       회귀+분류       표시
```

---

## 2. 데이터 수집

### 2.1 수집 기간 및 범위
| 항목 | 내용 |
|------|------|
| 수집 기간 | 2022년 1월 ~ 2025년 6월 (약 3.5년) |
| 대상 시장 | KOSPI, KOSDAQ |
| 시가총액 필터 | 1,000억원 이상 |
| 제외 종목 | ETF, 스팩, 리츠 등 |

### 2.2 52주 신고가 돌파 정의
```
돌파 조건: 당일 종가 > 직전 250거래일(52주) 최고가
```

### 2.3 라벨(정답) 정의
```
성공 (label=1): 돌파일 종가 대비 20거래일 내 최고가가 10% 이상 상승
실패 (label=0): 10% 미만 상승 또는 하락
```

### 2.4 수집된 데이터
| 항목 | 값 |
|------|------|
| 총 샘플 수 | 약 4,000건 |
| 성공 비율 (baseline) | 약 40% |
| 평균 최고 수익률 | 약 10% |

### 2.5 중복 방지
- 동일 종목의 연속 돌파를 방지하기 위해 최소 20거래일 간격 유지
- 이를 통해 독립적인 이벤트만 학습 데이터로 사용

---

## 3. 피처 엔지니어링

### 3.1 피처 설계 철학
돌파의 "품질"을 다각도로 평가할 수 있는 14개 피처를 6개 카테고리로 설계:

### 3.2 피처 목록 (14개)

#### A. 돌파 품질 (3개)
| 피처명 | 설명 | 계산 방법 |
|--------|------|-----------|
| `breakout_pct` | 돌파 강도 | (돌파일 종가 - 52주 고가) / 52주 고가 × 100 |
| `volume_surge` | 거래량 급증 | 돌파일 거래량 / 50일 평균 거래량 |
| `close_strength` | 종가 강도 | (종가 - 저가) / (고가 - 저가) |

**해석**: 돌파 강도가 높고, 거래량이 동반되며, 종가가 고가 근처에서 마감할수록 강한 돌파

#### B. 베이스 품질 (3개)
| 피처명 | 설명 | 계산 방법 |
|--------|------|-----------|
| `base_length` | 베이스 기간 | 직전 52주 고가 이후 경과일 |
| `volatility_contraction` | 변동성 수축 | 최근 5일 변동폭 / 20일 변동폭 |
| `volume_dry_up` | 거래량 고갈 | 최근 10일 평균 / 50일 평균 거래량 |

**해석**: 충분히 오랜 기간 횡보하며 변동성과 거래량이 줄어든 후 돌파하는 것이 이상적

#### C. 추세 상태 (2개)
| 피처명 | 설명 | 계산 방법 |
|--------|------|-----------|
| `ma200_slope` | 장기 추세 | (현재 200MA - 20일전 200MA) / 20일전 200MA |
| `pct_above_52w_low` | 저점 대비 상승률 | (종가 - 52주 저가) / 52주 저가 × 100 |

**해석**: 장기 이동평균선이 상승 중이고, 저점에서 충분히 반등한 종목이 유리

#### D. 상대강도 (2개)
| 피처명 | 설명 | 계산 방법 |
|--------|------|-----------|
| `rs_vs_market` | 시장 대비 강도 | 종목 20일 수익률 - 시장 20일 수익률 |
| `market_return` | 시장 상황 | KOSPI/KOSDAQ 20일 수익률 |

**해석**: 시장보다 강한 종목이, 시장 상승기에 돌파할 때 유리

#### E. 리스크 지표 (2개)
| 피처명 | 설명 | 계산 방법 |
|--------|------|-----------|
| `ma20_deviation` | 이격도 | 종가 / 20일 이동평균 - 1 |
| `liquidity` | 유동성 | 5일 평균 거래대금 |

**해석**: 20일선에서 과도하게 벗어나면 조정 가능성, 유동성이 높아야 안정적

#### F. 저항선/변동성 (2개)
| 피처명 | 설명 | 계산 방법 |
|--------|------|-----------|
| `days_since_ath` | ATH 이후 경과일 | 역사적 신고가 이후 경과일 |
| `atr_ratio` | ATR 비율 | ATR(14) / 현재가 × 100 |

**해석**: ATH 근처에서는 저항이 적고, ATR이 낮으면 변동성 리스크 낮음

### 3.3 피처와 타겟의 상관관계

분석 결과 (절대값 순):
```
피처                    상관계수
──────────────────────────────
ma20_deviation         -0.0521  (음의 상관)
breakout_pct           -0.0361  (음의 상관)
rs_vs_market           -0.0281  (음의 상관)
pct_above_52w_low      -0.0272  (음의 상관)
volume_surge           +0.0201  (양의 상관)
atr_ratio              -0.0189  (음의 상관)
```

**해석**: 개별 피처의 선형 상관관계는 낮으나, 비선형 조합을 통해 예측력 확보

---

## 4. 모델 선정

### 4.1 비교 대상 모델
총 7개 모델을 3가지 피처셋으로 비교:

**회귀 모델:**
- Ridge Regression
- Lasso Regression
- Random Forest Regressor
- XGBoost Regressor
- LightGBM Regressor
- Voting Ensemble (RF + XGB + LGBM)
- Stacking Ensemble

**분류 모델:**
- Logistic Regression
- Random Forest Classifier
- XGBoost Classifier
- LightGBM Classifier
- Gradient Boosting Classifier

### 4.2 피처셋 비교
| 피처셋 | 구성 | 피처 수 |
|--------|------|---------|
| A | 전체 피처 | 14개 |
| B | 상관관계 상위 | 8개 |
| C | VIF 기반 선택 | 9개 |

### 4.3 교차검증 방법
- **회귀**: 5-Fold Cross Validation
- **분류**: 5-Fold Stratified Cross Validation (클래스 비율 유지)

### 4.4 모델 선정 결과

**회귀 모델 비교 (R² 기준):**
```
피처셋          모델            MAE     RMSE    R²
──────────────────────────────────────────────────
A_14features   LightGBM       11.52   16.84   0.0292
A_14features   XGBoost        11.54   16.85   0.0285
A_14features   Stacking       11.54   16.86   0.0278
```

**분류 모델 비교 (Precision 기준):**
```
피처셋  모델           Precision  Recall   F1      AUC
────────────────────────────────────────────────────────
A      LightGBM        0.5012    0.5821   0.5386   0.6015
A      XGBoost         0.4923    0.5912   0.5373   0.5998
A      GradientBoosting 0.4856   0.5534   0.5173   0.5912
```

### 4.5 최종 선정 모델
| 용도 | 모델 | 이유 |
|------|------|------|
| 회귀 (예상 수익률) | LightGBM Regressor | 가장 높은 R², 빠른 학습 속도 |
| 분류 (성공 확률) | LightGBM Classifier | 높은 Precision, AUC |

---

## 5. 모델 학습

### 5.1 하이퍼파라미터 튜닝

**회귀 모델 파라미터:**
```python
{
    'n_estimators': 200,
    'max_depth': 3,          # 과적합 방지를 위해 낮게
    'learning_rate': 0.01,   # 느린 학습으로 일반화
    'subsample': 0.8,        # 랜덤 샘플링
    'reg_alpha': 1.0,        # L1 정규화
    'reg_lambda': 5.0        # L2 정규화
}
```

**분류 모델 파라미터:**
```python
{
    'n_estimators': 200,
    'max_depth': 5,
    'learning_rate': 0.05,
    'subsample': 0.8,
    'colsample_bytree': 0.8
}
```

### 5.2 피처 스케일링
- StandardScaler 사용 (평균 0, 표준편차 1로 정규화)
- 피처 간 스케일 차이가 큰 경우 (예: liquidity는 억 단위, close_strength는 0~1) 스케일링 필수

### 5.3 학습 결과

**회귀 모델 성능:**
| 지표 | 값 | 해석 |
|------|------|------|
| MAE | 11.52% | 평균 예측 오차 ±11.52%p |
| RMSE | 16.84% | 큰 오차에 민감한 지표 |
| R² | 0.0292 (2.9%) | 전체 변동의 2.9% 설명 |

**분류 모델 성능:**
| 지표 | 값 | 해석 |
|------|------|------|
| Accuracy | 57.2% | 전체 정확도 |
| **Precision** | **50.1%** | **예측이 맞을 확률** |
| Recall | 58.2% | 실제 성공 중 포착률 |
| F1 | 53.9% | 조화 평균 |
| AUC | 0.60 | 분류 능력 |

### 5.4 피처 중요도 (분류 모델 기준)
```
순위  피처                    중요도
───────────────────────────────────
 1   pct_above_52w_low        2,847
 2   days_since_ath           2,341
 3   base_length              2,186
 4   volume_surge             1,923
 5   atr_ratio                1,845
 6   rs_vs_market             1,756
 7   breakout_pct             1,689
 8   liquidity                1,534
 9   ma20_deviation           1,423
10   volatility_contraction   1,312
```

---

## 6. 모델 해석

### 6.1 성능 평가

**R² = 2.9%의 의미:**
- 주식 수익률 예측은 본질적으로 매우 어려운 문제
- 효율적 시장 가설(EMH)에 따르면 과거 정보로 미래 수익률 예측 불가
- 2.9%의 설명력은 낮아 보이지만, 금융 데이터에서는 의미 있는 수준
- 참고: 대부분의 퀀트 전략도 유사한 수준의 예측력을 가짐

**Precision = 50%의 의미:**
- 모델이 "성공할 것"이라고 예측한 종목 중 실제로 50%가 성공
- 기준선(baseline)인 40%보다 10%p 높음
- **모델이 예측한 종목에 집중하면 성공 확률이 25% 향상** (40% → 50%)

### 6.2 모델의 한계

1. **낮은 설명력**: R² 2.9%는 대부분의 변동을 설명하지 못함
2. **노이즈가 많은 데이터**: 주가는 뉴스, 시장 심리 등 예측 불가 요인에 영향
3. **과거 ≠ 미래**: 과거 패턴이 미래에도 유효하다는 보장 없음
4. **시장 환경 변화**: 상승장/하락장에 따라 모델 성능 차이

### 6.3 모델의 활용 가치

1. **종목 선별 도구**: 확률이 높은 종목에 집중할 수 있음
2. **리스크 관리**: 낮은 확률 종목 회피
3. **정량적 기준**: 주관적 판단 대신 객관적 지표 제공

---

## 7. 서비스 적용

### 7.1 실시간 예측 흐름
```
1. 매일 장 마감 후 스크리너 실행
2. 52주 신고가 돌파 종목 탐색
3. 돌파 시점의 14개 피처 계산
4. StandardScaler로 정규화
5. 회귀 모델 → 예상 최고 수익률
6. 분류 모델 → 성공 확률 (10%+ 확률)
7. 웹사이트에 결과 표시
```

### 7.2 추천 로직
```python
if 성공확률 >= 60% and 예상수익률 >= 10%:
    추천 = "BUY"
elif 성공확률 >= 50% or 예상수익률 >= 5%:
    추천 = "HOLD"
else:
    추천 = "PASS"
```

### 7.3 웹사이트 표시 예시
| 종목명 | 돌파일 | 돌파강도 | 거래량비 | 예상 최고수익 | 성공 확률 | 추천 |
|--------|--------|----------|----------|--------------|-----------|------|
| 현대시멘트 | 2월2일 | +22.7% | 37.9x | +38.6% | 87.0% | BUY |
| 삼양옵틱스 | 1월30일 | +44.0% | 49.9x | +42.7% | 87.8% | BUY |
| 웅진씽크빅 | 2월2일 | +1.7% | 2.1x | +21.7% | 79.0% | BUY |

---

## 8. 결론

### 8.1 주요 성과
1. **14개 기술적 피처** 설계 및 데이터셋 구축
2. **LightGBM** 기반 회귀/분류 모델 개발
3. **종목 선별 효과** 입증 (baseline 40% → 모델 예측 50%)

### 8.2 모델 요약
| 항목 | 회귀 모델 | 분류 모델 |
|------|-----------|-----------|
| 알고리즘 | LightGBM Regressor | LightGBM Classifier |
| 타겟 | 20일 내 최고 수익률 | 10% 이상 상승 여부 |
| 주요 지표 | R² = 2.9% | Precision = 50% |
| 출력 | predicted_gain (%) | success_probability (%) |

### 8.3 향후 개선 방향
1. **추가 피처**: 섹터 정보, 외국인/기관 수급, 뉴스 센티먼트
2. **시계열 모델**: LSTM, Transformer 활용
3. **앙상블 강화**: 시장 환경별 다른 모델 적용
4. **백테스팅**: 실제 투자 시뮬레이션으로 수익률 검증

---

## 부록

### A. 파일 구조
```
ml/
├── data/
│   ├── training_data.csv        # 원본 학습 데이터
│   └── training_data_v2.csv     # 피처 추가 버전
├── models/
│   ├── regressor.pkl            # 회귀 모델
│   ├── classifier.pkl           # 분류 모델
│   ├── scaler.pkl               # StandardScaler
│   └── model_meta.pkl           # 모델 메타데이터
└── src/
    ├── collect_training_data.py # 데이터 수집
    ├── add_features.py          # 피처 추가
    ├── model_comparison.py      # 모델 비교
    ├── final_model.py           # 최종 모델 학습
    └── predictor.py             # 예측기 클래스
```

### B. 사용 라이브러리
- **데이터 수집**: FinanceDataReader
- **데이터 처리**: pandas, numpy
- **모델 학습**: scikit-learn, LightGBM
- **모델 비교**: XGBoost (비교용)

### C. 참고 문헌
1. William O'Neil, "How to Make Money in Stocks" - CANSLIM 전략
2. Mark Minervini, "Trade Like a Stock Market Wizard" - 신고가 돌파 전략
3. Kaggle 주식 예측 대회 - 피처 엔지니어링 참고

---

*작성일: 2026년 2월*
*버전: 1.0*
